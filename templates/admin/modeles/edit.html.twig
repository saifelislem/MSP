{% extends 'admin/base.html.twig' %}

{% block title %}Modifier {{ modele.nom }}{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>✏️ Modifier le Modèle</h1>
    <a href="{{ path('admin_modeles_index') }}" class="btn btn-secondary">← Retour</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    <div class="mb-3">
                        <label for="nom" class="form-label">Nom du modèle *</label>
                        <input type="text" class="form-control" id="nom" name="nom" value="{{ modele.nom }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ modele.description }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="image" class="form-label">Image du modèle *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="image" name="image" value="{{ modele.image }}" required readonly>
                            <button type="button" class="btn btn-outline-secondary" id="selectImageBtn">
                                <i class="fa fa-folder-open"></i> Parcourir
                            </button>
                            <button type="button" class="btn btn-outline-success" id="uploadImageBtn">
                                <i class="fa fa-upload"></i> Uploader
                            </button>
                        </div>
                        <small class="text-muted">Sélectionnez une image depuis la galerie ou uploadez-en une nouvelle</small>
                        
                        <!-- Aperçu de l'image -->
                        <div id="imagePreview" class="mt-2" {{ modele.image ? '' : 'style="display: none;"' }}>
                            <img id="previewImg" src="{{ modele.image ? asset(modele.image) : '' }}" alt="Aperçu" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                            <button type="button" class="btn btn-sm btn-danger ms-2" id="removeImageBtn">
                                <i class="fa fa-times"></i> Supprimer
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="prixBase" class="form-label">Prix de base (€) *</label>
                        <input type="number" step="0.01" class="form-control" id="prixBase" name="prixBase" value="{{ modele.prixBase }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="formuleCalcul" class="form-label">Formule de calcul personnalisée</label>
                        <textarea class="form-control" id="formuleCalcul" name="formuleCalcul" rows="4" placeholder="Ex: (largeur * hauteur * 0.5) + prixBase&#10;Variables disponibles: largeur, hauteur, prixBase, quantite">{{ modele.formuleCalcul }}</textarea>
                        <small class="text-muted">
                            <strong>Variables disponibles:</strong> largeur, hauteur, prixBase, quantite<br>
                            <strong>Exemple:</strong> (largeur * hauteur * 0.5) + prixBase<br>
                            <strong>Laissez vide</strong> pour utiliser seulement le prix de base
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="category" class="form-label">Catégorie</label>
                        <select class="form-select" id="category" name="category_id">
                            <option value="">-- Aucune catégorie --</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {{ modele.category and modele.category.id == category.id ? 'selected' : '' }}>
                                    {{ category.nom }}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Associez ce modèle à une catégorie pour l'organiser</small>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="actif" name="actif" value="1" {{ modele.actif ? 'checked' : '' }}>
                        <label class="form-check-label" for="actif">
                            Actif (visible sur le site)
                        </label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i> Enregistrer
                        </button>
                        <a href="{{ path('admin_modeles_index') }}" class="btn btn-secondary">Annuler</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Aperçu</h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ asset(modele.image) }}" alt="{{ modele.nom }}" class="img-fluid" style="max-height: 300px; object-fit: contain;">
                <p class="mt-3"><strong>{{ modele.nom }}</strong></p>
                <p class="text-muted">{{ modele.prixBase|number_format(2) }}€</p>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
<script src="{{ asset('js/file-picker.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('image');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removeImageBtn = document.getElementById('removeImageBtn');

    // Sélectionner une image existante
    selectImageBtn.addEventListener('click', function() {
        filePicker.open(function(path) {
            imageInput.value = path;
            showImagePreview(path);
            updateMainPreview(path);
        }, 'models');
    });

    // Uploader une nouvelle image
    uploadImageBtn.addEventListener('click', function() {
        const tempInput = document.createElement('input');
        tempInput.type = 'file';
        tempInput.accept = 'image/*';
        tempInput.style.display = 'none';
        
        tempInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadImage(this.files[0]);
            }
        });
        
        document.body.appendChild(tempInput);
        tempInput.click();
        document.body.removeChild(tempInput);
    });

    // Supprimer l'image sélectionnée
    removeImageBtn.addEventListener('click', function() {
        imageInput.value = '';
        hideImagePreview();
        updateMainPreview('');
    });

    // Fonction pour uploader une image
    function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('category', 'models');

        uploadImageBtn.disabled = true;
        uploadImageBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Upload...';

        fetch('/admin/files/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                imageInput.value = data.path;
                showImagePreview(data.path);
                updateMainPreview(data.path);
            } else {
                alert('Erreur lors de l\'upload: ' + data.error);
            }
        })
        .catch(error => {
            alert('Erreur lors de l\'upload: ' + error.message);
        })
        .finally(() => {
            uploadImageBtn.disabled = false;
            uploadImageBtn.innerHTML = '<i class="fa fa-upload"></i> Uploader';
        });
    }

    // Afficher l'aperçu de l'image
    function showImagePreview(path) {
        previewImg.src = path;
        imagePreview.style.display = 'block';
    }

    // Masquer l'aperçu de l'image
    function hideImagePreview() {
        imagePreview.style.display = 'none';
        previewImg.src = '';
    }

    // Mettre à jour l'aperçu principal
    function updateMainPreview(path) {
        const mainPreviewImg = document.querySelector('.col-md-4 .card-body img');
        if (mainPreviewImg && path) {
            mainPreviewImg.src = path;
        }
    }
});
</script>
{% endblock %}
{% endblock %}
