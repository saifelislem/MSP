{% extends 'admin/base.html.twig' %}

{% block title %}Commande {{ order.orderNumber }}{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üì¶ Commande {{ order.orderNumber }}</h1>
    <a href="{{ path('admin_orders_index') }}" class="btn btn-secondary">‚Üê Retour</a>
</div>

<div class="row">
    <!-- Informations commande -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">D√©tails de la commande</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Date:</strong> {{ order.createdAt|date('d/m/Y √† H:i') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Statut:</strong>
                        <span class="badge bg-{{ order.status == 'completed' ? 'success' : (order.status == 'pending' ? 'warning' : (order.status == 'cancelled' ? 'danger' : 'info')) }}">
                            {{ order.statusLabel }}
                        </span>
                    </div>
                </div>

                <hr>

                <h6>Articles command√©s</h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Produit</th>
                                <th>D√©tails</th>
                                <th>Prix unitaire</th>
                                <th>Quantit√©</th>
                                <th>Sous-total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.orderItems %}
                            <tr>
                                <td>
                                    {% if item.product.isLogoMode and item.product.logoData %}
                                        <!-- Afficher le logo upload√© -->
                                        <div style="width: 80px; height: 80px; border: 2px solid #007bff; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <img src="{{ item.product.logoData }}" alt="Logo" style="max-width: 70px; max-height: 70px; object-fit: contain;">
                                        </div>
                                    {% else %}
                                        <!-- Afficher l'image du mod√®le -->
                                        <img src="{{ asset(item.product.imageUrl ?: 'images/product-detail-01.jpg') }}" alt="{{ item.product.modeleName }}" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.product.isLogoMode %}
                                        <strong><i class="zmdi zmdi-image"></i> Logo personnalis√©</strong>
                                        {% if item.product.logoFileName %}
                                            <br><small class="text-muted">{{ item.product.logoFileName }}</small>
                                        {% endif %}
                                        {% if item.product.logoData %}
                                            <br>
                                            <a href="{{ item.product.logoData }}" download="logo_{{ item.product.id }}.png" class="btn btn-sm btn-success mt-2" style="font-size: 11px; padding: 4px 8px;">
                                                <i class="zmdi zmdi-download"></i> T√©l√©charger
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <strong>{{ item.product.text }}</strong>
                                    {% endif %}
                                    {% if item.product.modeleName %}
                                        <br><small class="text-muted">{{ item.product.modeleName }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ item.product.largeur }}√ó{{ item.product.hauteur }}cm<br>
                                    {% if item.product.isLogoMode %}
                                        <small>Ratio: {{ item.product.logoRatio ? (item.product.logoRatio|number_format(2)) : 'N/A' }}</small>
                                    {% else %}
                                        <small>{{ item.product.typeEcriture }}</small>
                                    {% endif %}
                                    <br>
                                    <div style="margin-top: 8px;">
                                        <small style="color: #666;">Couleurs:</small><br>
                                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <div style="width: 16px; height: 16px; background-color: {{ item.product.facadeColor|default('#2A2A2A') }}; border: 1px solid #ccc; border-radius: 3px;"></div>
                                                <small>Fa√ßade</small>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <div style="width: 16px; height: 16px; background-color: {{ item.product.sideColor|default('#E8E8E8') }}; border: 1px solid #ccc; border-radius: 3px;"></div>
                                                <small>C√¥t√©s</small>
                                            </div>
                                        </div>
                                        <small style="color: #999; font-size: 10px;">
                                            {{ item.product.facadeColor|default('#2A2A2A') }} / {{ item.product.sideColor|default('#E8E8E8') }}
                                        </small>
                                    </div>
                                </td>
                                <td>{{ item.price|number_format(2) }}‚Ç¨</td>
                                <td>{{ item.quantity }}</td>
                                <td><strong>{{ item.subtotal|number_format(2) }}‚Ç¨</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" class="text-end"><strong>Total:</strong></td>
                                <td><strong>{{ order.total|number_format(2) }}‚Ç¨</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations client -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header" style="background: #2F4E9B; color: white;">
                <h5 class="mb-0"><i class="zmdi zmdi-account-circle"></i> Informations Client</h5>
            </div>
            <div class="card-body">
                {% if order.customer %}
                    <div class="mb-3">
                        <strong style="color: #0F1A3A;">Nom complet:</strong><br>
                        <span style="font-size: 16px;">{{ order.customer.fullName }}</span>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #0F1A3A;">Email:</strong><br>
                        <a href="mailto:{{ order.customer.email }}" style="color: #2F4E9B;">{{ order.customer.email }}</a>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #0F1A3A;">T√©l√©phone:</strong><br>
                        <a href="tel:{{ order.customer.telephone }}" style="color: #2F4E9B;">{{ order.customer.telephone }}</a>
                    </div>
                    {% if order.customer.adresse %}
                    <div class="mb-3">
                        <strong style="color: #0F1A3A;">Adresse:</strong><br>
                        {{ order.customer.adresse }}<br>
                        {% if order.customer.codePostal %}{{ order.customer.codePostal }}{% endif %}
                        {% if order.customer.ville %}{{ order.customer.ville }}{% endif %}
                    </div>
                    {% endif %}
                    <div class="mb-0">
                        <small class="text-muted">Client depuis le {{ order.customer.createdAt|date('d/m/Y') }}</small><br>
                        <small class="text-muted">{{ order.customer.orders|length }} commande(s)</small>
                    </div>
                {% else %}
                    <p><strong>Nom:</strong><br>{{ order.customerName ?? 'Non renseign√©' }}</p>
                    <p><strong>Email:</strong><br>{{ order.customerEmail ?? 'Non renseign√©' }}</p>
                    <p><strong>T√©l√©phone:</strong><br>{{ order.customerPhone ?? 'Non renseign√©' }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header" style="background: #28a745; color: white;">
                <h5 class="mb-0"><i class="zmdi zmdi-file-text"></i> Facture</h5>
            </div>
            <div class="card-body">
                <a href="{{ path('invoice_download', {id: order.id}) }}" class="btn btn-success w-100 mb-2">
                    <i class="zmdi zmdi-download"></i> T√©l√©charger PDF
                </a>
                <a href="{{ path('invoice_view', {id: order.id}) }}" class="btn btn-info w-100" target="_blank">
                    <i class="zmdi zmdi-eye"></i> Voir la facture
                </a>
            </div>
        </div>

        <!-- Changer le statut -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Changer le statut</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ path('admin_orders_update_status', {id: order.id}) }}">
                    <select name="status" class="form-select mb-3">
                        <option value="pending" {{ order.status == 'pending' ? 'selected' : '' }}>En attente</option>
                        <option value="processing" {{ order.status == 'processing' ? 'selected' : '' }}>En cours</option>
                        <option value="completed" {{ order.status == 'completed' ? 'selected' : '' }}>Termin√©e</option>
                        <option value="cancelled" {{ order.status == 'cancelled' ? 'selected' : '' }}>Annul√©e</option>
                    </select>
                    <button type="submit" class="btn btn-primary w-100">Mettre √† jour</button>
                </form>
            </div>
        </div>

        <!-- Notes -->
        {% if order.notes %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Notes</h5>
            </div>
            <div class="card-body">
                <p>{{ order.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
