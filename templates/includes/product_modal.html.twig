<!-- Modal Quick View Product -->
<div class="wrap-modal1 js-modal1 p-t-60 p-b-20">
    <div class="overlay-modal1 js-hide-modal1" onclick="closeModal()"></div>

    <div class="container">
        <div class="bg0 p-t-60 p-b-30 p-lr-15-lg how-pos3-parent">
            <button class="how-pos3 hov3 trans-04 js-hide-modal1" onclick="closeModal()">
                <img src="{{ asset('images/icons/icon-close.png') }}" alt="CLOSE">
            </button>

            <!-- PARTIE 1 & 2: Image + Formulaire -->
            <div class="row" id="modal-product-content">
                <div class="col-md-5 col-lg-4 p-b-30">
                    <div class="p-l-25 p-r-30 p-lr-0-lg">
                        <div class="wrap-slick3 flex-sb flex-w">
                            <div class="slick3 gallery-lb">
                                <div class="item-slick3" data-thumb="{{ asset('images/product-detail-01.jpg') }}">
                                    <div class="wrap-pic-w pos-relative" style="max-height: 300px; overflow: hidden;">
                                        <img src="{{ asset('images/product-detail-01.jpg') }}" alt="IMG-PRODUCT" style="width: 100%; height: auto; max-height: 300px; object-fit: contain;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-7 col-lg-8 p-b-30">
                    <div class="p-r-50 p-t-5 p-lr-0-lg">
                        <h4 class="mtext-105 cl2 js-name-detail p-b-14" id="modal-product-title">
                            Personnalisez votre produit
                        </h4>



                        <p class="stext-102 cl3 p-t-23" id="modal-product-description">
                            <strong>Choisissez votre type d'enseigne</strong> : texte personnalis√© ou logo.
                        </p>

                        <!--  -->
                        <div class="p-t-33">
                            <!-- Onglets Texte / Logo -->
                            <div class="flex-w flex-r-m p-b-20">
                                <div class="size-203 flex-c-m respon6">
                                    Type
                                </div>
                                <div class="size-204 respon6-next">
                                    <div class="product-tabs" style="display: flex; gap: 10px;">
                                        <button type="button" class="tab-btn active" data-tab="text" style="flex: 1; padding: 10px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 5px; cursor: pointer;">
                                            <i class="zmdi zmdi-format-color-text m-r-5"></i>Texte
                                        </button>
                                        <button type="button" class="tab-btn" data-tab="logo" style="flex: 1; padding: 10px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 5px; cursor: pointer;">
                                            <i class="zmdi zmdi-image m-r-5"></i>Logo
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Contenu Texte -->
                            <div id="text-content" class="tab-content">
                                <!-- Texte -->
                                <div class="flex-w flex-r-m p-b-10">
                                    <div class="size-203 flex-c-m respon6">
                                        Texte
                                    </div>

                                    <div class="size-204 respon6-next">
                                        <div class="rs1-select2 bor8 bg0">
                                            <input type="text" id="modal-product-text" class="stext-104 cl2 plh3 size-116 p-lr-18" placeholder="Entrez votre texte ici..." maxlength="100" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contenu Logo -->
                            <div id="logo-content" class="tab-content" style="display: none;">
                                <!-- Upload de logo -->
                                <div class="flex-w flex-r-m p-b-10">
                                    <div class="size-203 flex-c-m respon6">
                                        Logo
                                    </div>

                                    <div class="size-204 respon6-next">
                                        <!-- Zone de drop -->
                                        <div id="logo-drop-zone" class="logo-upload-zone" style="
                                            border: 2px dashed #007bff;
                                            border-radius: 8px;
                                            padding: 30px;
                                            text-align: center;
                                            background: #f8f9fa;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        ">
                                            <div id="logo-upload-content">
                                                <i class="zmdi zmdi-cloud-upload" style="font-size: 48px; color: #007bff; margin-bottom: 10px;"></i>
                                                <p class="stext-102 cl2" style="margin: 0;">
                                                    <strong>Glissez votre logo ici</strong><br>
                                                    ou cliquez pour parcourir
                                                </p>
                                                <small class="stext-102 cl6">PNG, JPG, SVG - Max 5MB</small>
                                            </div>
                                            
                                            <!-- Aper√ßu du logo -->
                                            <div id="logo-preview" style="display: none;">
                                                <img id="logo-preview-img" style="max-width: 200px; max-height: 150px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                                <div style="margin-top: 10px;">
                                                    <button type="button" id="change-logo-btn" class="stext-102" style="background: none; border: 1px solid #007bff; color: #007bff; padding: 5px 15px; border-radius: 3px; cursor: pointer;">
                                                        Changer le logo
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Input file cach√© -->
                                        <input type="file" id="logo-file-input" accept="image/*,.svg" style="display: none;">
                                    </div>
                                </div>
                            </div>

                            <!-- Hauteur OU Largeur -->
                            <div class="flex-w flex-r-m p-b-10">
                                <div class="size-203 flex-c-m respon6">
                                    Dimensions
                                </div>

                                <div class="size-204 respon6-next">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="stext-102 cl2 p-b-5" style="display: block;">Hauteur (cm)</label>
                                            <div class="rs1-select2 bor8 bg0">
                                                <input type="number" id="modal-product-hauteur" class="stext-104 cl2 plh3 size-116 p-lr-18" placeholder="Ex: 20" min="1" max="200" step="0.1">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="stext-102 cl2 p-b-5" style="display: block;">Largeur (cm)</label>
                                            <div class="rs1-select2 bor8 bg0">
                                                <input type="number" id="modal-product-largeur" class="stext-104 cl2 plh3 size-116 p-lr-18" placeholder="Ex: 60" min="1" max="500" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                    <small class="stext-102 cl6 p-t-10" style="display: block;">Remplissez l'un des deux champs, l'autre se calculera automatiquement</small>
                                    <small class="stext-102" id="dimension-formula" style="display: block; margin-top: 8px; color: #28a745; font-weight: 500;"></small>
                                </div>
                            </div>

                            <!-- Type d'√©criture (seulement pour le texte) -->
                            <div class="flex-w flex-r-m p-b-10" id="font-section">
                                <div class="size-203 flex-c-m respon6">
                                    Police
                                </div>

                                <div class="size-204 respon6-next">
                                    <div class="rs1-select2 bor8 bg0">
                                        <select class="js-select2" id="modal-product-typeEcriture">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Comic Sans MS">Comic Sans MS</option>
                                            <option value="Impact">Impact</option>
                                            <option value="Trebuchet MS">Trebuchet MS</option>
                                        </select>
                                        <div class="dropDownSelect2"></div>
                                    </div>
                                </div>
                            </div>



                            <!-- Quantit√© -->
                            <div class="flex-w flex-r-m p-b-10">
                                <div class="size-203 flex-c-m respon6">
                                    Quantit√©
                                </div>

                                <div class="size-204 respon6-next">
                                    <div class="wrap-num-product flex-w m-r-20 m-tb-10">
                                        <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-minus"></i>
                                        </div>

                                        <input class="mtext-104 cl3 txt-center num-product" type="number" id="modal-product-quantity" value="1" min="1">

                                        <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                                            <i class="fs-16 zmdi zmdi-plus"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--  -->
                            <div class="flex-w flex-r-m p-t-10">
                                <button class="flex-c-m stext-101 cl0 size-101 bg3 bor1 hov-btn1 p-lr-15 trans-04 js-addcart-detail" onclick="addToCartFromModal()">
                                    <i class="zmdi zmdi-shopping-cart m-r-8"></i>
                                    Ajouter au panier
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PARTIE 3: Aper√ßu 3D + Personnalisation c√¥te √† c√¥te -->
            <div class="row m-t-30">
                <div class="col-12">
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 30px;">
                        <div class="row" style="margin: 0;">
                            <!-- Aper√ßu 3D √† gauche (65%) -->
                            <div class="col-md-8" style="padding-right: 10px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); padding: 20px; height: 650px; display: flex; flex-direction: column;">
                                    <!-- Titre -->
                                    <h5 class="mtext-107" style="color: white; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                                        <i class="zmdi zmdi-eye"></i> Aper√ßu 3D R√©aliste
                                    </h5>
                                    
                                    <!-- Canvas 3D -->
                                    <div style="background: #f5f5f5; border-radius: 8px; overflow: hidden; flex: 1; position: relative;">
                                        <div id="preview-3d-container" style="width: 100%; height: 100%; background: #1a1a1a; cursor: grab;">
                                            <canvas id="three-canvas" style="width: 100%; height: 100%;"></canvas>
                                            
                                            <!-- Overlay dimensions -->
                                            <div id="dimension-overlay" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 8px; font-size: 13px; pointer-events: none; border: 1px solid rgba(255,255,255,0.2);">
                                                <div style="margin-bottom: 8px;">
                                                    <i class="zmdi zmdi-ruler"></i> <strong>Largeur:</strong> <span id="dim-width">10 cm</span>
                                                </div>
                                                <div style="margin-bottom: 8px;">
                                                    <i class="zmdi zmdi-ruler"></i> <strong>Hauteur:</strong> <span id="dim-height">10 cm</span>
                                                </div>
                                                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                                                    <i class="zmdi zmdi-layers"></i> <strong>Profondeur:</strong> <span style="color: #4CAF50;">5 mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Infos bas -->
                                    <div class="p-t-10" style="display: flex; justify-content: space-between; align-items: center; color: white;">
                                        <div id="preview-font-info">
                                            <small style="opacity: 0.8;">Police:</small>
                                            <span id="preview-font" style="font-weight: 600; margin-left: 5px;">Arial</span>
                                        </div>
                                        <div>
                                            <small style="opacity: 0.8; font-size: 11px;">
                                                <i class="zmdi zmdi-mouse"></i> Glissez | <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">R</kbd> Reset
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Personnalisation √† droite (35%) -->
                            <div class="col-md-4" style="padding-left: 10px;">
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: 650px; display: flex; flex-direction: column;">
                                    <h6 class="mtext-106" style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin: 0 0 20px 0;">
                                        <i class="zmdi zmdi-palette"></i> Personnalisation
                                    </h6>
                                    
                                    <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;">
                                        
                                    <!-- Couleur de la fa√ßade -->
                                    <div id="facade-color-section-3d">
                                        <label class="stext-102 cl2 p-b-8" style="display: block; font-weight: 600;">
                                            <i class="zmdi zmdi-colorize"></i> Couleur fa√ßade (texte/logo)
                                        </label>
                                        <select class="stext-104 cl2 size-116" id="modal-product-facade-color" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="#2A2A2A">‚ö´ Noir</option>
                                            <option value="#FFFFFF">‚ö™ Blanc</option>
                                            <option value="#E74C3C">üî¥ Rouge</option>
                                            <option value="#3498DB">üîµ Bleu</option>
                                            <option value="#2ECC71">üü¢ Vert</option>
                                            <option value="#F39C12">üü† Orange</option>
                                            <option value="#9B59B6">üü£ Violet</option>
                                            <option value="#E91E63">üå∏ Rose</option>
                                            <option value="#FFD700">üü° Or</option>
                                            <option value="#C0C0C0">‚ö™ Argent</option>
                                            <option value="#8B4513">üü§ Marron</option>
                                            <option value="#00BCD4">üî∑ Cyan</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Couleur des c√¥t√©s -->
                                    <div id="side-color-section-3d">
                                        <label class="stext-102 cl2 p-b-8" style="display: block; font-weight: 600;">
                                            <i class="zmdi zmdi-border-color"></i> Couleur c√¥t√©s (tranches)
                                        </label>
                                        <select class="stext-104 cl2 size-116" id="modal-product-side-color" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="#E8E8E8" selected>‚ö™ Gris clair</option>
                                            <option value="#2A2A2A">‚ö´ Noir</option>
                                            <option value="#FFFFFF">‚ö™ Blanc</option>
                                            <option value="#E74C3C">üî¥ Rouge</option>
                                            <option value="#3498DB">üîµ Bleu</option>
                                            <option value="#2ECC71">üü¢ Vert</option>
                                            <option value="#F39C12">üü† Orange</option>
                                            <option value="#9B59B6">üü£ Violet</option>
                                            <option value="#E91E63">üå∏ Rose</option>
                                            <option value="#FFD700">üü° Or</option>
                                            <option value="#C0C0C0">‚ö™ Argent</option>
                                            <option value="#8B4513">üü§ Marron</option>
                                            <option value="#00BCD4">üî∑ Cyan</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Finition -->
                                    <div id="material-section-3d">
                                        <label class="stext-102 cl2 p-b-8" style="display: block; font-weight: 600;">
                                            <i class="zmdi zmdi-brush"></i> Finition
                                        </label>
                                        <select class="stext-104 cl2 size-116" id="modal-product-material" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="matte">Mat</option>
                                            <option value="glossy">Brillant</option>
                                            <option value="metallic">M√©tallique</option>
                                            <option value="chrome">Chrome</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Type de mur -->
                                    <div>
                                        <label class="stext-102 cl2 p-b-8" style="display: block; font-weight: 600;">
                                            <i class="zmdi zmdi-view-dashboard"></i> Type de mur
                                        </label>
                                        <select class="stext-104 cl2 size-116" id="modal-wall-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="white">üè† Mur Blanc</option>
                                            <option value="brick">üß± Mur Brique</option>
                                            <option value="wood">ü™µ Mur Bois</option>
                                            <option value="concrete">üèóÔ∏è Mur B√©ton</option>
                                            <option value="dark">üåô Mur Sombre</option>
                                            <option value="modern">‚ú® Mur Moderne</option>
                                        </select>
                                        <small class="stext-102 cl6 p-t-5" style="display: block; font-size: 10px;">Visualisez sur diff√©rents murs</small>
                                    </div>
                                        
                                    <!-- Info -->
                                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 3px solid #2196F3; margin-top: auto;">
                                        <small class="stext-102" style="color: #1976D2; font-size: 10px; line-height: 1.4;">
                                            <i class="zmdi zmdi-info"></i> <strong>Astuce:</strong> Glissez la souris pour voir sous tous les angles!
                                        </small>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles pour le conteneur 3D */
#preview-3d-container {
    position: relative;
}

#preview-3d-container:active {
    cursor: grabbing !important;
}

#three-canvas {
    display: block;
}
</style>

<!-- Three.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/TextGeometry.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
// Coefficients de police pour le calcul
const fontCoefficients = {
    'Arial': 0.45,
    'Times New Roman': 0.42,
    'Courier New': 0.50,
    'Georgia': 0.43,
    'Verdana': 0.48,
    'Comic Sans MS': 0.47,
    'Impact': 0.52,
    'Trebuchet MS': 0.46
};

// Variables globales pour le mode et les donn√©es du logo
let currentMode = 'text';
let logoData = null;
let logoRatio = null;

// Variables Three.js
let scene, camera, renderer, textMesh, logoMesh, controls;
let loadedFont = null;

// Fonction pour fermer le modal
window.closeModal = function() {
    const modal = document.querySelector('.js-modal1');
    if (modal) {
        modal.classList.remove('show-modal1');
    }
};

// Variable pour stocker le groupe de la pi√®ce
let roomGroup = null;

// Cr√©er une pi√®ce 3D avec diff√©rents styles de murs
window.createRoom = function(wallType) {
    // Supprimer l'ancienne pi√®ce
    if (roomGroup) {
        scene.remove(roomGroup);
        roomGroup.traverse(function(child) {
            if (child.geometry) child.geometry.dispose();
            if (child.material) child.material.dispose();
        });
    }
    
    roomGroup = new THREE.Group();
    
    // D√©finir les mat√©riaux selon le type de mur
    let backWallMaterial, sideWallMaterial, floorMaterial;
    
    switch(wallType) {
        case 'brick':
            // Mur brique
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xA0522D,
                roughness: 0.9,
                metalness: 0.0
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x8B4513,
                roughness: 0.9,
                metalness: 0.0
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x8B7355,
                roughness: 0.9,
                metalness: 0.0
            });
            break;
        case 'wood':
            // Mur bois
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xD2691E,
                roughness: 0.7,
                metalness: 0.0
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xCD853F,
                roughness: 0.7,
                metalness: 0.0
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xA0826D,
                roughness: 0.6,
                metalness: 0.0
            });
            break;
        case 'concrete':
            // Mur b√©ton
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x9E9E9E,
                roughness: 0.95,
                metalness: 0.0
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x808080,
                roughness: 0.95,
                metalness: 0.0
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x757575,
                roughness: 0.9,
                metalness: 0.0
            });
            break;
        case 'dark':
            // Mur sombre
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2C3E50,
                roughness: 0.8,
                metalness: 0.1
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x34495E,
                roughness: 0.8,
                metalness: 0.1
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1C2833,
                roughness: 0.7,
                metalness: 0.1
            });
            break;
        case 'modern':
            // Mur moderne (gris clair)
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xECF0F1,
                roughness: 0.5,
                metalness: 0.2
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xBDC3C7,
                roughness: 0.5,
                metalness: 0.2
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x95A5A6,
                roughness: 0.4,
                metalness: 0.3
            });
            break;
        default:
            // Mur blanc (d√©faut)
            backWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xF5F5F5,
                roughness: 0.8,
                metalness: 0.0
            });
            sideWallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xE8E8E8,
                roughness: 0.8,
                metalness: 0.0
            });
            floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xDDDDDD,
                roughness: 0.9,
                metalness: 0.0
            });
    }
    
    // Mur du fond
    const backWallGeometry = new THREE.PlaneGeometry(20, 15);
    const backWall = new THREE.Mesh(backWallGeometry, backWallMaterial);
    backWall.position.z = -5;
    backWall.receiveShadow = true;
    roomGroup.add(backWall);
    
    // Mur de gauche
    const leftWallGeometry = new THREE.PlaneGeometry(15, 15);
    const leftWall = new THREE.Mesh(leftWallGeometry, sideWallMaterial);
    leftWall.position.x = -10;
    leftWall.position.z = 2.5;
    leftWall.rotation.y = Math.PI / 2;
    leftWall.receiveShadow = true;
    roomGroup.add(leftWall);
    
    // Mur de droite
    const rightWall = new THREE.Mesh(leftWallGeometry, sideWallMaterial.clone());
    rightWall.position.x = 10;
    rightWall.position.z = 2.5;
    rightWall.rotation.y = -Math.PI / 2;
    rightWall.receiveShadow = true;
    roomGroup.add(rightWall);
    
    // Sol
    const floorGeometry = new THREE.PlaneGeometry(20, 15);
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -7.5;
    floor.receiveShadow = true;
    roomGroup.add(floor);
    
    // Plafond
    const ceiling = new THREE.Mesh(floorGeometry, backWallMaterial.clone());
    ceiling.rotation.x = Math.PI / 2;
    ceiling.position.y = 7.5;
    ceiling.receiveShadow = true;
    roomGroup.add(ceiling);
    
    scene.add(roomGroup);
};

// Initialiser Three.js
window.initThreeJS = function() {
    const container = document.getElementById('preview-3d-container');
    if (!container) return;
    
    // Sc√®ne
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xE8E8E8); // Gris clair
    
    // Cam√©ra avec perspective
    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(5, 2, 8); // Position en angle pour voir la perspective
    camera.lookAt(0, 0, 0);
    
    // Renderer
    const canvas = document.getElementById('three-canvas');
    renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // Lumi√®res
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    
    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(10, 10, 10);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    scene.add(mainLight);
    
    const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
    fillLight.position.set(-5, 5, 5);
    scene.add(fillLight);
    
    // Cr√©er la pi√®ce 3D
    createRoom('white');
    
    // OrbitControls - pour tourner la cam√©ra autour de la sc√®ne
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; // Animation fluide
    controls.dampingFactor = 0.05;
    controls.minDistance = 5; // Distance minimale
    controls.maxDistance = 20; // Distance maximale
    controls.maxPolarAngle = Math.PI / 2; // Ne pas aller sous le sol
    controls.target.set(0, 0, 0); // Point de focus
    
    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update(); // Mettre √† jour les contr√¥les
        renderer.render(scene, camera);
    }
    animate();
    
    // Gestion du resize
    window.addEventListener('resize', function() {
        if (container.clientWidth > 0) {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
    });
};

// Cr√©er le texte 3D avec profondeur de 5mm
window.create3DText = function(text, font, material) {
    // Supprimer l'ancien mesh
    if (textMesh) {
        scene.remove(textMesh);
        textMesh.geometry.dispose();
        textMesh.material.dispose();
    }
    
    // Cr√©er la g√©om√©trie du texte avec extrusion de 5mm (0.5 en unit√©s Three.js)
    const loader = new THREE.FontLoader();
    
    // Utiliser une police par d√©faut de Three.js
    const shapes = font.generateShapes(text, 1);
    const geometry = new THREE.ExtrudeGeometry(shapes, {
        depth: 0.5, // 5mm de profondeur
        bevelEnabled: true,
        bevelThickness: 0.05,
        bevelSize: 0.05,
        bevelSegments: 3
    });
    
    geometry.computeBoundingBox();
    const centerOffset = -0.5 * (geometry.boundingBox.max.x - geometry.boundingBox.min.x);
    
    // Mat√©riau selon le choix
    let meshMaterial;
    switch(material) {
        case 'metal':
            meshMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x888888,
                metalness: 0.9,
                roughness: 0.2
            });
            break;
        case 'gold':
            meshMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xFFD700,
                metalness: 0.8,
                roughness: 0.3
            });
            break;
        case 'blue':
            meshMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4A90E2,
                metalness: 0.8,
                roughness: 0.3
            });
            break;
        default:
            meshMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xC0C0C0,
                metalness: 0.9,
                roughness: 0.2
            });
    }
    
    textMesh = new THREE.Mesh(geometry, meshMaterial);
    textMesh.position.x = centerOffset;
    textMesh.position.y = -0.5;
    textMesh.castShadow = true;
    textMesh.receiveShadow = true;
    
    scene.add(textMesh);
};

// Cr√©er le logo 3D avec couleurs fa√ßade et c√¥t√©s personnalisables
window.create3DLogo = function(imageData) {
    // Supprimer l'ancien mesh
    if (logoMesh) {
        scene.remove(logoMesh);
        if (logoMesh.geometry) logoMesh.geometry.dispose();
        if (Array.isArray(logoMesh.material)) {
            logoMesh.material.forEach(mat => mat.dispose());
        } else if (logoMesh.material) {
            logoMesh.material.dispose();
        }
    }
    
    // R√©cup√©rer les couleurs choisies
    const sideColor = document.getElementById('modal-product-side-color').value || '#E8E8E8';
    const sideColorValue = parseInt(sideColor.replace('#', '0x'));
    
    // Charger la texture
    const textureLoader = new THREE.TextureLoader();
    textureLoader.load(imageData, function(texture) {
        // Cr√©er une g√©om√©trie avec extrusion de 5mm - LOGO AGRANDI
        const width = 8;  // Augment√© de 5 √† 8
        const height = 5; // Augment√© de 3 √† 5
        const depth = 0.5; // 5mm de profondeur
        
        const geometry = new THREE.BoxGeometry(width, height, depth);
        
        // Mat√©riaux pour chaque face avec couleur c√¥t√©s personnalisable
        const sideMaterial = new THREE.MeshStandardMaterial({ 
            color: sideColorValue, 
            metalness: 0.9, 
            roughness: 0.2,
            emissive: sideColorValue,
            emissiveIntensity: 0.05
        });
        
        const frontMaterial = new THREE.MeshStandardMaterial({ 
            map: texture,
            metalness: 0.3,
            roughness: 0.4
        });
        
        const materials = [
            sideMaterial.clone(), // c√¥t√© droit
            sideMaterial.clone(), // c√¥t√© gauche
            sideMaterial.clone(), // haut
            sideMaterial.clone(), // bas
            frontMaterial,        // face avant avec texture
            sideMaterial.clone()  // face arri√®re
        ];
        
        logoMesh = new THREE.Mesh(geometry, materials);
        logoMesh.position.z = -4.75; // Coll√© sur le mur du fond
        logoMesh.castShadow = true;
        logoMesh.receiveShadow = false;
        // Pas de rotation - le logo reste fixe sur le mur
        
        // Ajouter des contours pour plus de r√©alisme
        const edges = new THREE.EdgesGeometry(geometry);
        const lineMaterial = new THREE.LineBasicMaterial({ 
            color: 0x000000, 
            opacity: 0.3, 
            transparent: true 
        });
        const wireframe = new THREE.LineSegments(edges, lineMaterial);
        logoMesh.add(wireframe);
        
        scene.add(logoMesh);
    });
};

// Mettre √† jour l'aper√ßu 3D
window.updatePreview = function() {
    const largeur = document.getElementById('modal-product-largeur').value || '10';
    const hauteur = document.getElementById('modal-product-hauteur').value || '10';
    
    // Mettre √† jour les dimensions dans l'overlay
    document.getElementById('dim-width').textContent = largeur + ' cm';
    document.getElementById('dim-height').textContent = hauteur + ' cm';
    
    if (currentMode === 'text') {
        updateTextPreview();
    } else if (currentMode === 'logo') {
        updateLogoPreview();
    }
};

// Mettre √† jour l'aper√ßu texte 3D
window.updateTextPreview = function() {
    const textInput = document.getElementById('modal-product-text');
    const text = textInput && textInput.value ? textInput.value : 'Votre texte';
    const font = document.getElementById('modal-product-typeEcriture').value || 'Arial';
    const facadeColor = document.getElementById('modal-product-facade-color').value || '#2A2A2A';
    const sideColor = document.getElementById('modal-product-side-color').value || '#E8E8E8';
    const material = document.getElementById('modal-product-material').value || 'matte';
    
    // Debug: afficher le texte r√©cup√©r√©
    console.log('Texte √† afficher dans l\'aper√ßu 3D:', text);
    
    // Supprimer le logo 3D s'il existe
    if (logoMesh) {
        if (logoMesh.geometry) logoMesh.geometry.dispose();
        if (Array.isArray(logoMesh.material)) {
            logoMesh.material.forEach(mat => mat.dispose());
        } else if (logoMesh.material) {
            logoMesh.material.dispose();
        }
        scene.remove(logoMesh);
        logoMesh = null;
    }
    
    // Afficher l'info police
    const fontInfo = document.getElementById('preview-font-info');
    if (fontInfo) fontInfo.style.display = 'block';
    document.getElementById('preview-font').textContent = font;
    
    // Cr√©er le texte 3D avec les couleurs fa√ßade et c√¥t√©s
    createSimple3DText(text, facadeColor, sideColor, material, font);
};

// Cache des polices charg√©es
const fontCache = {};

// Mapping des polices vers les fichiers Three.js
const fontMapping = {
    'Arial': 'helvetiker_bold.typeface.json',
    'Times New Roman': 'gentilis_bold.typeface.json',
    'Courier New': 'helvetiker_regular.typeface.json',
    'Georgia': 'gentilis_regular.typeface.json',
    'Verdana': 'helvetiker_bold.typeface.json',
    'Comic Sans MS': 'helvetiker_regular.typeface.json',
    'Impact': 'helvetiker_bold.typeface.json',
    'Trebuchet MS': 'helvetiker_bold.typeface.json'
};

// Charger la police pour le texte 3D
window.loadFont = function(fontName, callback) {
    // V√©rifier si la police est d√©j√† en cache
    if (fontCache[fontName]) {
        callback(fontCache[fontName]);
        return;
    }
    
    const loader = new THREE.FontLoader();
    const fontFile = fontMapping[fontName] || 'helvetiker_bold.typeface.json';
    const fontUrl = 'https://threejs.org/examples/fonts/' + fontFile;
    
    loader.load(fontUrl, function(font) {
        fontCache[fontName] = font;
        callback(font);
    }, undefined, function(error) {
        console.error('Erreur de chargement de la police:', error);
        // Fallback vers Helvetica
        if (fontFile !== 'helvetiker_bold.typeface.json') {
            loader.load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', function(font) {
                fontCache[fontName] = font;
                callback(font);
            });
        }
    });
};

// Cr√©er un texte 3D avec couleurs fa√ßade et c√¥t√©s s√©par√©es
window.createSimple3DText = function(text, facadeColor, sideColor, finish, fontName) {
    // Debug: v√©rifier le texte re√ßu
    console.log('createSimple3DText appel√©e avec le texte:', text);
    
    // S'assurer que le texte n'est pas vide ou undefined
    if (!text || text.trim() === '') {
        text = 'Votre texte';
    }
    
    // Supprimer compl√®tement l'ancien mesh
    if (textMesh) {
        if (textMesh.geometry) {
            textMesh.geometry.dispose();
        }
        if (textMesh.material) {
            if (Array.isArray(textMesh.material)) {
                textMesh.material.forEach(m => m.dispose());
            } else {
                textMesh.material.dispose();
            }
        }
        scene.remove(textMesh);
        textMesh = null;
    }
    
    // Charger la police et cr√©er le texte
    loadFont(fontName || 'Arial', function(font) {
        // Convertir les couleurs hex en nombres
        const facadeColorValue = parseInt(facadeColor.replace('#', '0x'));
        const sideColorValue = parseInt(sideColor.replace('#', '0x'));
        
        // Cr√©er les mat√©riaux pour fa√ßade et c√¥t√©s
        function createMaterial(colorValue, finish) {
            switch(finish) {
                case 'glossy':
                    return new THREE.MeshStandardMaterial({ 
                        color: colorValue,
                        metalness: 0.2,
                        roughness: 0.1,
                        emissive: colorValue,
                        emissiveIntensity: 0.1
                    });
                case 'metallic':
                    return new THREE.MeshStandardMaterial({ 
                        color: colorValue,
                        metalness: 0.8,
                        roughness: 0.3
                    });
                case 'chrome':
                    return new THREE.MeshStandardMaterial({ 
                        color: colorValue,
                        metalness: 1.0,
                        roughness: 0.1
                    });
                default:
                    return new THREE.MeshStandardMaterial({ 
                        color: colorValue,
                        metalness: 0.1,
                        roughness: 0.9
                    });
            }
        }
        
        // Mat√©riaux pour chaque face
        const facadeMaterial = createMaterial(facadeColorValue, finish);
        const sideMaterial = createMaterial(sideColorValue, finish);
        
        // Ajuster la taille selon la police
        let fontSize = 1.5;
        if (fontName === 'Times New Roman' || fontName === 'Georgia') {
            fontSize = 1.6;
        } else if (fontName === 'Courier New') {
            fontSize = 1.4;
        }
        
        // Cr√©er la g√©om√©trie du texte avec extrusion de 5mm
        const textGeometry = new THREE.TextGeometry(text, {
            font: font,
            size: fontSize,
            height: 0.5,            // Profondeur de 5mm
            curveSegments: 12,
            bevelEnabled: true,
            bevelThickness: 0.03,
            bevelSize: 0.02,
            bevelSegments: 5
        });
        
        // Cr√©er un array de mat√©riaux pour chaque face
        // Index 0 = face avant (fa√ßade), Index 1 = face arri√®re et c√¥t√©s
        const materials = [
            facadeMaterial,  // Face avant (fa√ßade)
            sideMaterial     // C√¥t√©s et face arri√®re
        ];
        
        // Centrer le texte
        textGeometry.computeBoundingBox();
        const centerOffset = -0.5 * (textGeometry.boundingBox.max.x - textGeometry.boundingBox.min.x);
        
        textMesh = new THREE.Mesh(textGeometry, materials);
        textMesh.position.x = centerOffset;
        textMesh.position.y = 0;
        textMesh.position.z = -4.75; // Coll√© sur le mur du fond
        textMesh.castShadow = true;
        textMesh.receiveShadow = false;
        
        scene.add(textMesh);
    });
};

// Mettre √† jour l'aper√ßu logo
window.updateLogoPreview = function() {
    const fontInfo = document.getElementById('preview-font-info');
    if (fontInfo) fontInfo.style.display = 'none';
    
    // Supprimer le texte 3D s'il existe
    if (textMesh) {
        if (textMesh.geometry) textMesh.geometry.dispose();
        if (textMesh.material) {
            if (Array.isArray(textMesh.material)) {
                textMesh.material.forEach(m => m.dispose());
            } else {
                textMesh.material.dispose();
            }
        }
        scene.remove(textMesh);
        textMesh = null;
    }
    
    if (logoData) {
        create3DLogo(logoData);
    } else {
        // Afficher un message si pas de logo upload√©
        console.log('Aucun logo upload√©');
    }
};

// R√©initialiser la vue de la cam√©ra
window.resetCameraView = function() {
    if (controls) {
        controls.reset();
        camera.position.set(5, 2, 8);
        camera.lookAt(0, 0, 0);
    }
};

// Touche R pour r√©initialiser la vue
document.addEventListener('keydown', function(e) {
    if (e.key === 'r' || e.key === 'R') {
        resetCameraView();
    }
});

// Variable pour √©viter les appels multiples
let updateTimeout = null;

// Calcul automatique de la largeur bas√© sur la hauteur
window.calculateLargeur = function() {
    const hauteur = parseFloat(document.getElementById('modal-product-hauteur').value);
    const text = document.getElementById('modal-product-text').value;
    const font = document.getElementById('modal-product-typeEcriture').value;
    
    if (hauteur && text && currentMode === 'text') {
        const N = text.length;
        const C = fontCoefficients[font] || 0.45;
        const largeur = (hauteur * C * N) * 1.07;
        document.getElementById('modal-product-largeur').value = largeur.toFixed(1);
    }
    
    // Debounce pour √©viter les appels multiples
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(function() {
        updatePreview();
    }, 300);
};

// Calcul automatique de la hauteur bas√© sur la largeur
window.calculateHauteur = function() {
    const largeur = parseFloat(document.getElementById('modal-product-largeur').value);
    const text = document.getElementById('modal-product-text').value;
    const font = document.getElementById('modal-product-typeEcriture').value;
    
    if (largeur && text && currentMode === 'text') {
        const N = text.length;
        const C = fontCoefficients[font] || 0.45;
        const hauteur = largeur / ((C * N) * 1.07);
        document.getElementById('modal-product-hauteur').value = hauteur.toFixed(1);
    }
    
    // Debounce pour √©viter les appels multiples
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(function() {
        updatePreview();
    }, 300);
};

// Calcul des dimensions pour le logo
window.calculateLogoDimensions = function(changedField) {
    if (currentMode !== 'logo' || !logoRatio) return;
    
    const hauteurInput = document.getElementById('modal-product-hauteur');
    const largeurInput = document.getElementById('modal-product-largeur');
    
    if (changedField === 'hauteur') {
        const hauteur = parseFloat(hauteurInput.value);
        if (hauteur) {
            largeurInput.value = (hauteur * logoRatio).toFixed(1);
        }
    } else if (changedField === 'largeur') {
        const largeur = parseFloat(largeurInput.value);
        if (largeur) {
            hauteurInput.value = (largeur / logoRatio).toFixed(1);
        }
    }
    updatePreview();
};

// Gestion de l'upload du logo
window.setupLogoUpload = function() {
    const dropZone = document.getElementById('logo-drop-zone');
    const fileInput = document.getElementById('logo-file-input');
    const logoPreview = document.getElementById('logo-preview');
    const logoUploadContent = document.getElementById('logo-upload-content');
    const changeLogoBtn = document.getElementById('change-logo-btn');
    
    // Click sur la zone de drop
    dropZone.addEventListener('click', function(e) {
        if (e.target.id !== 'change-logo-btn') {
            fileInput.click();
        }
    });
    
    // Drag & drop
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#0056b3';
        dropZone.style.background = '#e7f3ff';
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#007bff';
        dropZone.style.background = '#f8f9fa';
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#007bff';
        dropZone.style.background = '#f8f9fa';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleLogoFile(files[0]);
        }
    });
    
    // S√©lection de fichier
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleLogoFile(e.target.files[0]);
        }
    });
    
    // Bouton changer le logo
    changeLogoBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });
};

// Traitement du fichier logo
window.handleLogoFile = function(file) {
    // Validation
    if (!file.type.match('image.*')) {
        alert('Veuillez s√©lectionner une image valide');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        alert('Le fichier est trop volumineux (max 5MB)');
        return;
    }
    
    // Lecture du fichier
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Calculer le ratio
            logoRatio = img.width / img.height;
            logoData = e.target.result;
            
            // Afficher l'aper√ßu
            showLogoPreview(e.target.result);
            
            // Calculer les dimensions initiales
            const hauteur = 10;
            document.getElementById('modal-product-hauteur').value = hauteur;
            document.getElementById('modal-product-largeur').value = (hauteur * logoRatio).toFixed(1);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
};

// Afficher l'aper√ßu du logo
window.showLogoPreview = function(dataUrl) {
    const logoPreview = document.getElementById('logo-preview');
    const logoUploadContent = document.getElementById('logo-upload-content');
    const logoPreviewImg = document.getElementById('logo-preview-img');
    
    logoPreviewImg.src = dataUrl;
    logoUploadContent.style.display = 'none';
    logoPreview.style.display = 'block';
    
    // Mettre √† jour l'aper√ßu 3D
    updatePreview();
};

// Fonction pour ajouter au panier depuis le modal
window.addToCartFromModal = function() {
    const largeur = document.getElementById('modal-product-largeur').value;
    const hauteur = document.getElementById('modal-product-hauteur').value;
    const quantity = document.getElementById('modal-product-quantity').value;
    const imageUrl = document.getElementById('modal-product-text').getAttribute('data-image-url') || '/images/product-detail-01.jpg';
    const modeleName = document.getElementById('modal-product-text').getAttribute('data-model-name') || 'Produit personnalis√©';
    const modeleId = document.getElementById('modal-product-text').getAttribute('data-modele-id') || null;
    
    // Validation des dimensions
    if (!largeur || largeur < 1) {
        alert('‚ö†Ô∏è Veuillez entrer une largeur valide (minimum 1 cm)');
        return;
    }
    
    if (!hauteur || hauteur < 1) {
        alert('‚ö†Ô∏è Veuillez entrer une hauteur valide (minimum 1 cm)');
        return;
    }
    
    const productData = {
        mode: currentMode,
        largeur: largeur,
        hauteur: hauteur,
        quantity: quantity,
        imageUrl: imageUrl,
        modeleName: modeleName,
        modeleId: modeleId // Ajouter l'ID du mod√®le pour le calcul
    };
    
    // Ajouter les donn√©es sp√©cifiques au mode
    if (currentMode === 'text') {
        const text = document.getElementById('modal-product-text').value;
        const typeEcriture = document.getElementById('modal-product-typeEcriture').value;
        const material = document.getElementById('modal-product-material').value;
        
        if (!text || text.trim() === '') {
            alert('‚ö†Ô∏è Veuillez entrer un texte pour votre produit');
            return;
        }
        
        productData.text = text;
        productData.typeEcriture = typeEcriture;
        productData.material = material;
    } else if (currentMode === 'logo') {
        if (!logoData) {
            alert('‚ö†Ô∏è Veuillez uploader un logo');
            return;
        }
        
        productData.logoData = logoData;
        productData.logoRatio = logoRatio;
    }
    
    // Ajouter les couleurs fa√ßade et c√¥t√©s
    productData.facadeColor = document.getElementById('modal-product-facade-color').value || '#2A2A2A';
    productData.sideColor = document.getElementById('modal-product-side-color').value || '#E8E8E8';
    
    // Envoyer au serveur
    fetch('/cart/add-custom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(productData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal
            closeModal();
            
            // Afficher une notification avec le prix calcul√©
            const message = `Produit ajout√© au panier pour ${data.calculatedPrice ? data.calculatedPrice.toFixed(2) + '‚Ç¨' : 'un prix calcul√©'}`;
            
            if (typeof swal !== 'undefined') {
                swal({
                    title: "Produit ajout√©!",
                    text: message,
                    icon: "success",
                    button: "OK"
                }).then(() => {
                    // Recharger la page pour mettre √† jour le panier
                    window.location.reload();
                });
            } else {
                alert(message);
                // Recharger la page pour mettre √† jour le panier
                window.location.reload();
            }
        } else {
            alert('Erreur: ' + (data.message || 'Une erreur est survenue'));
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de l\'ajout au panier');
    });
};

// Initialisation au chargement du DOM
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des onglets
    const tabButtons = document.querySelectorAll('.tab-btn');
    const textContent = document.getElementById('text-content');
    const logoContent = document.getElementById('logo-content');
    const fontSection = document.getElementById('font-section');
    const materialSection = document.getElementById('material-section');
    
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            currentMode = tab;
            
            // Mettre √† jour les styles des boutons
            tabButtons.forEach(b => {
                b.classList.remove('active');
                b.style.background = 'white';
                b.style.color = '#007bff';
            });
            this.classList.add('active');
            this.style.background = '#007bff';
            this.style.color = 'white';
            
            // Afficher/masquer le contenu
            const colorSection3d = document.getElementById('color-section-3d');
            const materialSection3d = document.getElementById('material-section-3d');
            
            if (tab === 'text') {
                textContent.style.display = 'block';
                logoContent.style.display = 'none';
                fontSection.style.display = 'flex';
                if (colorSection3d) colorSection3d.style.display = 'block';
                if (materialSection3d) materialSection3d.style.display = 'block';
            } else {
                textContent.style.display = 'none';
                logoContent.style.display = 'block';
                fontSection.style.display = 'none';
                if (colorSection3d) colorSection3d.style.display = 'none';
                if (materialSection3d) materialSection3d.style.display = 'none';
            }
            
            // Mettre √† jour l'aper√ßu
            updatePreview();
        });
    });
    
    // Event listeners pour les champs
    const textInput = document.getElementById('modal-product-text');
    const largeurInput = document.getElementById('modal-product-largeur');
    const hauteurInput = document.getElementById('modal-product-hauteur');
    const typeEcritureSelect = document.getElementById('modal-product-typeEcriture');
    
    if (textInput) {
        textInput.addEventListener('input', function() {
            console.log('Texte saisi:', this.value);
            if (currentMode === 'text') {
                calculateLargeur();
                // Forcer la mise √† jour de l'aper√ßu apr√®s un court d√©lai
                setTimeout(() => {
                    updateTextPreview();
                }, 100);
            }
        });
    }
    
    if (largeurInput) {
        largeurInput.addEventListener('input', function() {
            if (currentMode === 'text') {
                calculateHauteur();
            } else if (currentMode === 'logo') {
                calculateLogoDimensions('largeur');
            }
        });
    }
    
    if (hauteurInput) {
        hauteurInput.addEventListener('input', function() {
            if (currentMode === 'text') {
                calculateLargeur();
            } else if (currentMode === 'logo') {
                calculateLogoDimensions('hauteur');
            }
        });
    }
    
    if (typeEcritureSelect) {
        typeEcritureSelect.addEventListener('change', function() {
            if (currentMode === 'text') {
                calculateLargeur();
                updatePreview();
            }
        });
    }
    
    // Event listener pour le mat√©riau/finition
    const materialSelect = document.getElementById('modal-product-material');
    if (materialSelect) {
        materialSelect.addEventListener('change', function() {
            updatePreview();
        });
    }
    
    // Event listeners pour les couleurs fa√ßade et c√¥t√©s
    const facadeColorSelect = document.getElementById('modal-product-facade-color');
    if (facadeColorSelect) {
        facadeColorSelect.addEventListener('change', function() {
            updatePreview();
        });
    }
    
    const sideColorSelect = document.getElementById('modal-product-side-color');
    if (sideColorSelect) {
        sideColorSelect.addEventListener('change', function() {
            updatePreview();
        });
    }
    
    // Event listener pour le type de mur
    const wallTypeSelect = document.getElementById('modal-wall-type');
    if (wallTypeSelect) {
        wallTypeSelect.addEventListener('change', function() {
            const wallType = this.value;
            createRoom(wallType);
        });
    }
    
    // Initialiser Three.js
    initThreeJS();
    
    // Initialiser l'upload du logo
    setupLogoUpload();
    
    // Initialiser l'aper√ßu
    updatePreview();
});
</script>
