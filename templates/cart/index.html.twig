<!DOCTYPE html>
<html lang="en">
<head>
    <title>Mon Panier</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="{{ asset('images/icons/favicon.png') }}"/>
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('fonts/font-awesome-4.7.0/css/font-awesome.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('fonts/iconic/css/material-design-iconic-font.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('fonts/linearicons-v1.0.0/icon-font.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/animate/animate.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/css-hamburgers/hamburgers.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/animsition/css/animsition.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/select2/select2.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/perfect-scrollbar/perfect-scrollbar.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/util.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/main.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/custom-theme.css') }}">
    <style>
        body { padding-top: 80px; }
    </style>
</head>
<body class="animsition">

    {% include 'includes/header.html.twig' %}

    <!-- Sidebar Panier -->
    {% include 'includes/cart_sidebar.html.twig' %}

    <!-- breadcrumb -->
    <div class="container">
        <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
            <a href="{{ path('app_home') }}" class="stext-109 cl8 hov-cl1 trans-04">
                Accueil
                <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
            </a>
            <span class="stext-109 cl4">Panier</span>
        </div>
    </div>

    <!-- Panier -->
    <section class="bg0 p-t-75 p-b-85">
        <div class="container">
            <h2 class="ltext-109 cl2 p-b-30 txt-center">
                <i class="zmdi zmdi-shopping-cart m-r-10"></i>Mon Panier
                <small class="stext-102 cl6">({{ cart.cartItems|length }} article(s))</small>
            </h2>
            <div class="row">
                <div class="col-lg-8 col-xl-8 m-b-50">
            
                        {% if cart.cartItems|length > 0 %}
                            <div class="wrap-table-shopping-cart">
                                <table class="table-shopping-cart">
                                    <thead>
                                        <tr class="table_head">
                                            <th class="column-1" style="text-align: center;">Produit</th>
                                            <th class="column-2" style="text-align: center;">Détails</th>
                                            <th class="column-3" style="text-align: center;">Prix</th>
                                            <th class="column-4" style="text-align: center;">Quantité</th>
                                            <th class="column-5" style="text-align: center;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in cart.cartItems %}
                                        <tr class="table_row" data-item-id="{{ item.id }}">
                                            <td class="column-1" style="text-align: center; vertical-align: middle;"></td>
                                                <div class="how-itemcart1" style="margin: 0 auto;"></div>
                                                    <img src="{{ asset(item.product.imageUrl ?: 'images/product-detail-01.jpg') }}" alt="{{ item.product.modeleName ?: 'Produit' }}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px;">
                                                </div>
                                            </td>
                                            <td class="column-2">
                                                <div class="p-l-15" style="text-align: center;">
                                                    <h6 class="mtext-105 cl2 p-b-5" style="text-align: center;">{{ item.product.text }}</h6>
                                                    <p class="stext-102 cl6" style="text-align: center;"></p>
                                                        {{ item.product.largeur }}cm × {{ item.product.hauteur }}cm<br>
                                                        Police: {{ item.product.typeEcriture }}
                                                    </p>
                                                    {% if item.product.modeleName %}
                                                    <p class="stext-102 cl5 p-t-5" style="text-align: center;"></p>
                                                        <strong>Type: {{ item.product.modeleName }}</strong>
                                                    </p>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="column-3" style="text-align: center; vertical-align: middle;">{{ item.price|number_format(2) }}€</td>
                                            <td class="column-4" style="text-align: center; vertical-align: middle;">
                                                <div class="wrap-num-product flex-w" style="margin: 0 auto; justify-content: center;"></div>
                                                    <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m" onclick="updateQuantity({{ item.id }}, {{ item.quantity - 1 }})">
                                                        <i class="fs-16 zmdi zmdi-minus"></i>
                                                    </div>
                                                    <input class="mtext-104 cl3 txt-center num-product" type="number" value="{{ item.quantity }}" min="1" onchange="updateQuantity({{ item.id }}, this.value)">
                                                    <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m" onclick="updateQuantity({{ item.id }}, {{ item.quantity + 1 }})">
                                                        <i class="fs-16 zmdi zmdi-plus"></i>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="column-5" style="text-align: center; vertical-align: middle;">{{ item.subtotal|number_format(2) }}€</td>
                                            <td class="column-6">
                                                <button class="how-itemcart1-delete hov-cl1 trans-04" onclick="removeFromCart({{ item.id }})">
                                                    <i class="zmdi zmdi-close"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="flex-w flex-sb-m p-t-25 p-b-25 bo8 p-lr-15 p-lr-0-sm">
                                <div class="flex-w flex-m m-r-20 m-tb-5">
                                    <button class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10" onclick="clearCart()">
                                        <i class="zmdi zmdi-delete m-r-5"></i> Vider le panier
                                    </button>
                                </div>

                                <div class="flex-w flex-m m-tb-5">
                                    <a href="{{ path('app_home') }}" class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                                        <i class="zmdi zmdi-arrow-left m-r-5"></i> Continuer les achats
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <div class="txt-center p-t-50 p-b-50">
                                <i class="zmdi zmdi-shopping-cart" style="font-size: 80px; color: #ccc;"></i>
                                <h4 class="mtext-109 cl6 p-t-20 p-b-20">Votre panier est vide</h4>
                                <a href="{{ path('app_home') }}" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer m-t-20">
                                    <i class="zmdi zmdi-shopping-basket m-r-5"></i> Continuer les achats
                                </a>
                            </div>
                        {% endif %}
                </div>

                <!-- Résumé du panier -->
                {% if cart.cartItems|length > 0 %}
                <div class="col-lg-4 col-xl-4 m-b-50">
                    <div class="bor10 p-lr-40 p-t-30 p-b-40 p-lr-15-sm" style="position: sticky; top: 100px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px;">
                        <h4 class="mtext-109 cl2 p-b-30">
                            <i class="zmdi zmdi-card m-r-10"></i>Résumé de la commande
                        </h4>

                        <div class="flex-w flex-t bor12 p-b-13">
                            <div class="size-208">
                                <span class="stext-110 cl2">Sous-total:</span>
                            </div>
                            <div class="size-209">
                                <span class="mtext-110 cl2">{{ cart.total|number_format(2) }}€</span>
                            </div>
                        </div>

                        <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                            <div class="size-208 w-full-ssm">
                                <span class="stext-110 cl2">Livraison:</span>
                            </div>
                            <div class="size-209 p-t-1">
                                <span class="stext-111 cl6">Gratuite</span>
                            </div>
                        </div>

                        <div class="flex-w flex-t p-t-27 p-b-33">
                            <div class="size-208">
                                <span class="mtext-101 cl2">Total:</span>
                            </div>
                            <div class="size-209 p-t-1">
                                <span class="mtext-110 cl2" id="cart-total">{{ cart.total|number_format(2) }}€</span>
                            </div>
                        </div>

                        <a href="{{ path('payment_create_checkout') }}" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; text-decoration: none; display: inline-block;">
                            <i class="zmdi zmdi-card m-r-5"></i> Payer maintenant
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </section>

    {% include 'includes/footer.html.twig' %}

    <!-- Modal Confirmation Rapide -->
    <div class="wrap-modal1 js-modal-checkout p-t-60 p-b-20" style="display: none;">
        <div class="overlay-modal1" onclick="closeQuickCheckout()"></div>
        <div class="container">
            <div class="bg0 p-t-60 p-b-30 p-lr-15-lg how-pos3-parent" style="max-width: 600px; margin: auto;">
                <button class="how-pos3 hov3 trans-04" onclick="closeQuickCheckout()">
                    <img src="{{ asset('images/icons/icon-close.png') }}" alt="CLOSE">
                </button>
                
                <h4 class="mtext-105 cl2 p-b-30 txt-center">
                    <i class="zmdi zmdi-account-circle m-r-10"></i>Finaliser la commande
                </h4>
                
                <form id="quick-checkout-form">
                    <div class="bor8 m-b-20 how-pos4-parent">
                        <input class="stext-111 cl2 plh3 size-116 p-l-20 p-r-30" type="text" name="name" placeholder="Nom complet *" required>
                    </div>
                    
                    <div class="bor8 m-b-20 how-pos4-parent">
                        <input class="stext-111 cl2 plh3 size-116 p-l-20 p-r-30" type="email" name="email" placeholder="Email *" required>
                    </div>
                    
                    <div class="bor8 m-b-20 how-pos4-parent">
                        <input class="stext-111 cl2 plh3 size-116 p-l-20 p-r-30" type="tel" name="phone" placeholder="Téléphone">
                    </div>
                    
                    <div class="bor8 m-b-30">
                        <textarea class="stext-111 cl2 plh3 size-120 p-lr-20 p-tb-15" name="notes" placeholder="Notes (optionnel)"></textarea>
                    </div>
                    
                    <button type="submit" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer w-full">
                        <i class="zmdi zmdi-check m-r-5"></i> Confirmer la commande
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

<script>
function updateQuantity(itemId, quantity) {
    if (quantity < 1) {
        removeFromCart(itemId);
        return;
    }
    
    fetch(`/cart/update/${itemId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function removeFromCart(itemId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) {
        fetch(`/cart/remove/${itemId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function clearCart() {
    if (confirm('Êtes-vous sûr de vouloir vider le panier ?')) {
        fetch('/cart/clear', {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

// Ouvrir le modal de confirmation rapide
function openQuickCheckout() {
    document.querySelector('.js-modal-checkout').style.display = 'block';
    setTimeout(() => {
        document.querySelector('.js-modal-checkout').classList.add('show-modal1');
    }, 10);
}

// Fermer le modal
function closeQuickCheckout() {
    document.querySelector('.js-modal-checkout').classList.remove('show-modal1');
    setTimeout(() => {
        document.querySelector('.js-modal-checkout').style.display = 'none';
    }, 300);
}

// Gérer la soumission du formulaire
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('quick-checkout-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="zmdi zmdi-refresh zmdi-hc-spin m-r-5"></i> Création en cours...';
            
            const formData = new FormData(this);
            
            fetch('/cart/create-order', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof swal !== 'undefined') {
                        swal({
                            title: "Commande créée!",
                            text: "Votre commande N°" + data.orderNumber + " a été créée avec succès!",
                            icon: "success",
                            button: "Voir ma commande"
                        }).then(() => {
                            window.location.href = '/cart/order-success/' + data.orderId;
                        });
                    } else {
                        alert('Commande créée: ' + data.orderNumber);
                        window.location.href = '/cart/order-success/' + data.orderId;
                    }
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    if (typeof swal !== 'undefined') {
                        swal("Erreur", data.message, "error");
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                if (typeof swal !== 'undefined') {
                    swal("Erreur", "Une erreur est survenue", "error");
                } else {
                    alert('Erreur lors de la création de la commande');
                }
            });
        });
    }
});
</script>

    <script src="{{ asset('vendor/jquery/jquery-3.2.1.min.js') }}"></script>
    <script src="{{ asset('vendor/animsition/js/animsition.min.js') }}"></script>
    <script src="{{ asset('vendor/bootstrap/js/popper.js') }}"></script>
    <script src="{{ asset('vendor/bootstrap/js/bootstrap.min.js') }}"></script>
    <script src="{{ asset('vendor/select2/select2.min.js') }}"></script>
    <script src="{{ asset('vendor/perfect-scrollbar/perfect-scrollbar.min.js') }}"></script>
    <script src="{{ asset('js/main.js') }}"></script>

</body>
</html>